<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft JS - Three.js</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }
        #crosshair::before, #crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }

        #instructions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            cursor: pointer;
            z-index: 20;
        }

        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
        }

        #hotbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
            gap: 5px;
        }

        .slot {
            width: 40px;
            height: 40px;
            border: 2px solid #555;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 0 #000;
            transition: border-color 0.2s;
        }

        .slot.active {
            border-color: white;
            transform: scale(1.1);
        }

        kbd {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #555;
        }
    </style>
    <!-- Import Maps для модулей Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- Прицел -->
    <div id="crosshair"></div>

    <!-- UI Инфо -->
    <div id="ui-layer">
        <div>Блоков: <span id="block-count">0</span></div>
        <div>FPS: <span id="fps-counter">60</span></div>
    </div>

    <!-- Меню/Инструкция -->
    <div id="instructions">
        <h1 style="font-size: 40px; margin-bottom: 10px;">MINECRAFT JS</h1>
        <p>Кликните, чтобы начать</p>
        <div style="text-align: left; margin-top: 20px; line-height: 1.6;">
            <div><kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> - Перемещение</div>
            <div><kbd>SPACE</kbd> - Прыжок</div>
            <div><kbd>ЛКМ</kbd> - Ломать блок</div>
            <div><kbd>ПКМ</kbd> - Ставить блок</div>
            <div><kbd>1</kbd>-<kbd>5</kbd> - Выбор блока</div>
        </div>
    </div>

    <!-- Панель быстрого доступа -->
    <div id="hotbar">
        <div class="slot active" data-type="grass" style="background: #5b8c38;">1</div>
        <div class="slot" data-type="dirt" style="background: #704828;">2</div>
        <div class="slot" data-type="stone" style="background: #666;">3</div>
        <div class="slot" data-type="wood" style="background: #4a331a;">4</div>
        <div class="slot" data-type="leaves" style="background: #3a5f0b;">5</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- КОНФИГУРАЦИЯ ---
        const WORLD_SIZE = 30; // Размер мира (радиус генерации)
        const BLOCK_SIZE = 1;
        
        // Переменные состояния
        let camera, scene, renderer, controls;
        let raycaster;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let canJump = false;
        
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        
        const objects = []; // Массив блоков для проверки столкновений и рейкаста
        const worldMap = new Map(); // Быстрый доступ к блокам по координатам "x,y,z"

        // Типы блоков и материалы
        let materials = {};
        let selectedBlockType = 'grass';

        // --- ИНИЦИАЛИЗАЦИЯ ---
        init();
        animate();

        function init() {
            // 1. Сцена и Камера
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Небесно-голубой
            scene.fog = new THREE.Fog(0x87CEEB, 10, 60);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 10;

            // 2. Свет
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            scene.add(dirLight);

            // 3. Генерация текстур (процедурная)
            const loader = new THREE.TextureLoader();
            materials = {
                grass: [
                    createMaterial('#5b8c38', '#456b2b'), // side
                    createMaterial('#5b8c38', '#456b2b'), // side
                    createMaterial('#7cbd44', '#5b8c38'), // top
                    createMaterial('#704828', '#52341b'), // bottom
                    createMaterial('#5b8c38', '#456b2b'), // side
                    createMaterial('#5b8c38', '#456b2b')  // side
                ],
                dirt: createMaterial('#704828', '#52341b'),
                stone: createMaterial('#777777', '#555555'),
                wood: createMaterial('#4a331a', '#332211'),
                leaves: createMaterial('#3a5f0b', '#2d4a08', true), // true для полупрозрачности
                glass: new THREE.MeshBasicMaterial({ color: 0x88ccff, transparent: true, opacity: 0.4 })
            };

            // 4. Генерация Мира
            generateWorld();

            // 5. Рендерер
            renderer = new THREE.WebGLRenderer({ antialias: false }); // Pixel style
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 6. Управление
            controls = new PointerLockControls(camera, document.body);

            const instructions = document.getElementById('instructions');
            instructions.addEventListener('click', () => {
                controls.lock();
            });

            controls.addEventListener('lock', () => {
                instructions.style.display = 'none';
            });
            controls.addEventListener('unlock', () => {
                instructions.style.display = 'flex';
            });

            scene.add(controls.getObject());

            // Рейкастер для взаимодействия
            raycaster = new THREE.Raycaster();
            raycaster.far = 8; // Дальность взаимодействия

            // Слушатели событий
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousedown', onMouseClick);
            document.addEventListener('keydown', onBlockSelect);
            window.addEventListener('resize', onWindowResize);
        }

        // --- ГЕНЕРАЦИЯ ТЕКСТУР ---
        function createMaterial(color1, color2, transparent = false) {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            // Заливка
            ctx.fillStyle = color1;
            ctx.fillRect(0, 0, 64, 64);

            // Шум
            ctx.fillStyle = color2;
            for(let i=0; i<400; i++) {
                const x = Math.floor(Math.random() * 64);
                const y = Math.floor(Math.random() * 64);
                const w = Math.floor(Math.random() * 5) + 1;
                const h = Math.floor(Math.random() * 5) + 1;
                ctx.fillRect(x, y, w, h);
            }
            
            // Рамка блока
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 4;
            ctx.strokeRect(0,0,64,64);

            const texture = new THREE.CanvasTexture(canvas);
            texture.magFilter = THREE.NearestFilter; // Пиксельный вид
            
            return new THREE.MeshLambertMaterial({ 
                map: texture,
                transparent: transparent 
            });
        }

        // --- ГЕНЕРАЦИЯ МИРА ---
        function generateWorld() {
            const geometry = new THREE.BoxGeometry(BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
            
            // Простая генерация ландшафта (Perlin noise симуляция через Math.sin)
            for (let x = -WORLD_SIZE/2; x < WORLD_SIZE/2; x++) {
                for (let z = -WORLD_SIZE/2; z < WORLD_SIZE/2; z++) {
                    // Высота ландшафта
                    const h = Math.floor(Math.sin(x * 0.1) * 2 + Math.cos(z * 0.1) * 2) + 2;

                    // Коренная порода
                    addBlock(x, -2, z, 'stone');

                    // Заполнение до высоты
                    for(let y = -1; y <= h; y++) {
                        let type = 'stone';
                        if(y === h) type = 'grass';
                        else if(y > h - 3) type = 'dirt';
                        
                        addBlock(x, y, z, type);
                    }

                    // Деревья (редко)
                    if (x > -10 && x < 10 && z > -10 && z < 10) continue; // Чистая зона спавна
                    if (Math.random() < 0.02 && h > 0) {
                        createTree(x, h + 1, z);
                    }
                }
            }
            updateBlockCount();
        }

        function createTree(x, y, z) {
            // Ствол
            for(let i=0; i<4; i++) addBlock(x, y+i, z, 'wood');
            // Листва
            for(let lx = -2; lx <= 2; lx++) {
                for(let ly = 3; ly <= 5; ly++) {
                    for(let lz = -2; lz <= 2; lz++) {
                        if (Math.abs(lx) === 2 && Math.abs(lz) === 2) continue; // Скругление углов
                        if (Math.random() > 0.2) {
                            // Не ставим листву внутри ствола
                            if(getBlock(x+lx, y+ly, z+lz) === undefined) {
                                addBlock(x+lx, y+ly, z+lz, 'leaves');
                            }
                        }
                    }
                }
            }
        }

        function addBlock(x, y, z, type) {
            const key = `${x},${y},${z}`;
            if (worldMap.has(key)) return; // Блок уже есть

            const geometry = new THREE.BoxGeometry(BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
            let material;
            
            if (type === 'grass' && Array.isArray(materials.grass)) {
                material = materials.grass;
            } else {
                material = materials[type];
            }

            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            mesh.name = type;
            
            scene.add(mesh);
            objects.push(mesh);
            worldMap.set(key, mesh);
        }

        function removeBlock(mesh) {
            const key = `${mesh.position.x},${mesh.position.y},${mesh.position.z}`;
            scene.remove(mesh);
            
            const index = objects.indexOf(mesh);
            if (index > -1) objects.splice(index, 1);
            
            worldMap.delete(key);
            
            // Очистка памяти
            if(Array.isArray(mesh.material)) {
                // materials переиспользуются, не диспозим их тут чтобы не сломать другие блоки
            }
            mesh.geometry.dispose();
            updateBlockCount();
        }

        function getBlock(x, y, z) {
            return worldMap.get(`${x},${y},${z}`);
        }

        // --- УПРАВЛЕНИЕ ИГРОЙ ---
        function onKeyDown(event) {
            switch (event.code) {
                case 'ArrowUp':
                case 'KeyW': moveForward = true; break;
                case 'ArrowLeft':
                case 'KeyA': moveLeft = true; break;
                case 'ArrowDown':
                case 'KeyS': moveBackward = true; break;
                case 'ArrowRight':
                case 'KeyD': moveRight = true; break;
                case 'Space': 
                    if (canJump === true) velocity.y += 12; // Сила прыжка
                    canJump = false;
                    break;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'ArrowUp':
                case 'KeyW': moveForward = false; break;
                case 'ArrowLeft':
                case 'KeyA': moveLeft = false; break;
                case 'ArrowDown':
                case 'KeyS': moveBackward = false; break;
                case 'ArrowRight':
                case 'KeyD': moveRight = false; break;
            }
        }

        function onBlockSelect(event) {
            const slots = document.querySelectorAll('.slot');
            let index = -1;
            
            if (event.key >= '1' && event.key <= '5') {
                index = parseInt(event.key) - 1;
            }

            if (index !== -1) {
                slots.forEach(s => s.classList.remove('active'));
                slots[index].classList.add('active');
                selectedBlockType = slots[index].dataset.type;
            }
        }

        function onMouseClick(event) {
            if (!controls.isLocked) return;

            // Ставим рейкастер по центру экрана
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(objects);

            if (intersects.length > 0) {
                const intersect = intersects[0];
                
                // ЛКМ (0) - Удалить блок
                if (event.button === 0) {
                    removeBlock(intersect.object);
                } 
                // ПКМ (2) - Поставить блок
                else if (event.button === 2) {
                    const pos = intersect.point.clone().add(intersect.face.normal.multiplyScalar(0.5));
                    pos.floor(); // Округляем до целых координат сетки
                    
                    // Не ставить блок в игрока
                    const playerPos = camera.position.clone();
                    // Простая проверка (игрок занимает 2 блока в высоту)
                    const distHead = pos.distanceTo(new THREE.Vector3(Math.round(playerPos.x), Math.round(playerPos.y), Math.round(playerPos.z)));
                    const distFeet = pos.distanceTo(new THREE.Vector3(Math.round(playerPos.x), Math.round(playerPos.y)-1, Math.round(playerPos.z)));
                    
                    if (distHead > 1 && distFeet > 1) {
                        addBlock(pos.x, pos.y, pos.z, selectedBlockType);
                        updateBlockCount();
                    }
                }
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function updateBlockCount() {
            document.getElementById('block-count').innerText = objects.length;
        }

        // --- ФИЗИКА И АНИМАЦИЯ ---
        function checkCollision(position) {
            // Очень простая AABB коллизия
            // Проверяем точку ног игрока
            const x = Math.round(position.x);
            const y = Math.round(position.y - 1.5); // Ноги
            const z = Math.round(position.z);
            
            return worldMap.has(`${x},${y},${z}`);
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked) {
                // Замедление
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 30.0 * delta; // Гравитация (9.8 * mass ~ 30 для ощущения игры)

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // Нормализация вектора движения

                if (moveForward || moveBackward) velocity.z -= direction.z * 100.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 100.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // --- ПРОСТАЯ ФИЗИКА КОЛЛИЗИЙ С ПОЛОМ ---
                // Получаем текущую позицию
                const p = controls.getObject().position;
                
                // Проверяем блок прямо под ногами
                // В Three.js высота камеры (глаз) это position.y
                // Допустим, рост игрока 1.6 единиц
                const playerHeight = 1.6;
                const feetY = p.y - playerHeight;
                
                // Ищем блок под ногами
                const groundBlockKey = `${Math.round(p.x)},${Math.round(feetY)},${Math.round(p.z)}`;
                
                // Если мы падаем (velocity.y < 0) и достигли земли
                if (worldMap.has(groundBlockKey) && velocity.y < 0) {
                     // "Прилипаем" к верхушке блока
                     const groundMesh = worldMap.get(groundBlockKey);
                     // Блок центрирован в 0.5, 1.5 и т.д. Верхняя грань блока = mesh.position.y + 0.5
                     const blockTop = groundMesh.position.y + 0.5;
                     
                     if (feetY < blockTop && feetY > blockTop - 1.0) {
                        velocity.y = 0;
                        p.y = blockTop + playerHeight;
                        canJump = true;
                     }
                }
                
                controls.getObject().position.y += (velocity.y * delta);

                // "Пол" мира (бесконечное падение с респавном)
                if (controls.getObject().position.y < -10) {
                    velocity.y = 0;
                    controls.getObject().position.set(0, 10, 0);
                }
            }

            prevTime = time;

            // Счетчик FPS (упрощенный)
            document.getElementById('fps-counter').innerText = Math.round(1/delta);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
