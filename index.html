<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft JS + Mods + Multiplayer</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: monospace; user-select: none; }
        
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 10;
        }
        #crosshair::before { content: ''; position: absolute; top: 9px; left: 0; width: 20px; height: 2px; background: rgba(255,255,255,0.8); }
        #crosshair::after { content: ''; position: absolute; top: 0; left: 9px; width: 2px; height: 20px; background: rgba(255,255,255,0.8); }
        
        #ui-layer { 
            position: absolute; top: 10px; left: 10px; 
            color: white; text-shadow: 1px 1px 0 #000; 
            pointer-events: none; z-index: 5;
        }
        
        #chat-log { 
            position: absolute; bottom: 80px; left: 10px; 
            color: white; text-shadow: 1px 1px 0 #000; 
            width: 400px; height: 150px; 
            overflow-y: auto; pointer-events: none; 
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            padding: 10px;
        }
        
        #mod-status { color: yellow; font-weight: bold; }
        
        #instructions {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
            z-index: 20; cursor: pointer;
        }
    </style>
    <!-- Подключаем Three.js через CDN -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="crosshair"></div>
    
    <div id="ui-layer">
        <h1>MC JS Multiplayer</h1>
        <div>Mods: <span id="mod-status">Scanning...</span></div>
        <div>Your ID: <span id="my-id">Offline</span></div>
    </div>
    
    <div id="chat-log"></div>

    <div id="instructions">
        <h1>Кликни чтобы играть</h1>
        <p>WASD - Ходить | SPACE - Прыжок | M - Магия (из мода)</p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- 1. ГЛОБАЛЬНЫЙ API ДЛЯ МОДОВ ---
        // Мы создаем объект window.GameAPI, чтобы моды могли к нему обращаться
        window.GameAPI = {
            THREE: THREE,           // Доступ к библиотеке Three.js
            scene: null,            // Сцена
            camera: null,           // Камера
            playerParams: {},       // Параметры игрока
            addBlock: null,         // Функция добавления блока
            chat: (msg) => logChat("[MOD]: " + msg)
        };

        // --- 2. ОСНОВНЫЕ ПЕРЕМЕННЫЕ ---
        let camera, scene, renderer, controls;
        const objects = []; // Массив объектов для коллизии
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let canJump = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        // Мультиплеер
        let socket;
        let myId = null;
        const otherPlayers = {}; // Хранилище других игроков {id: Mesh}

        // Запуск
        init();
        animate();
        initMultiplayer(); // Подключение к Python серверу
        loadMods();        // Загрузка модов из папки

        function init() {
            // Сцена
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 10, 60);

            // Камера
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 5;

            // Свет
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            scene.add(dirLight);

            // Пол (Зеленая трава)
            const geometry = new THREE.PlaneGeometry(200, 200);
            geometry.rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ color: 0x5b8c38 });
            const floor = new THREE.Mesh(geometry, material);
            scene.add(floor);
            objects.push(floor); // Добавляем пол в объекты (хотя коллизия пока простая)

            // Рендерер
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Управление
            controls = new PointerLockControls(camera, document.body);
            
            const instr = document.getElementById('instructions');
            instr.addEventListener('click', () => controls.lock());
            
            controls.addEventListener('lock', () => instr.style.display = 'none');
            controls.addEventListener('unlock', () => instr.style.display = 'flex');

            scene.add(controls.getObject());

            // Обработка клавиш
            const onKeyDown = (e) => {
                switch (e.code) {
                    case 'KeyW': moveForward = true; break;
                    case 'KeyA': moveLeft = true; break;
                    case 'KeyS': moveBackward = true; break;
                    case 'KeyD': moveRight = true; break;
                    case 'Space': 
                        if (canJump) velocity.y += 15; 
                        canJump = false; 
                        break;
                }
            };
            const onKeyUp = (e) => {
                switch (e.code) {
                    case 'KeyW': moveForward = false; break;
                    case 'KeyA': moveLeft = false; break;
                    case 'KeyS': moveBackward = false; break;
                    case 'KeyD': moveRight = false; break;
                }
            };
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            window.addEventListener('resize', onWindowResize);

            // --- ЗАПОЛНЯЕМ API ---
            window.GameAPI.scene = scene;
            window.GameAPI.camera = camera;
            window.GameAPI.renderer = renderer;
            
            // Функция для модов: Добавить блок
            window.GameAPI.addBlock = function(x, y, z, color = 0xff0000) {
                const geo = new THREE.BoxGeometry(1, 1, 1);
                const mat = new THREE.MeshStandardMaterial({ color: color });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(x, y, z);
                scene.add(mesh);
                objects.push(mesh);
                return mesh;
            };
        }

        // --- 3. ЗАГРУЗКА МОДОВ ---
        async function loadMods() {
            const statusEl = document.getElementById('mod-status');
            try {
                // Спрашиваем у сервера список файлов в папке mods
                const response = await fetch('/api/get_mods');
                if (!response.ok) throw new Error("API error");
                
                const mods = await response.json();
                
                if (mods.length === 0) {
                    statusEl.innerText = "0 mods found.";
                    return;
                }

                statusEl.innerText = `Loading ${mods.length} mods...`;
                
                // Подключаем каждый мод как <script type="module">
                for (const modFile of mods) {
                    const script = document.createElement('script');
                    script.src = `/mods/${modFile}`;
                    script.type = "module"; 
                    script.onload = () => logChat(`[System] Loaded mod: ${modFile}`);
                    script.onerror = () => logChat(`[Error] Failed to load: ${modFile}`);
                    document.body.appendChild(script);
                }
                statusEl.innerText = "Active";
            } catch (e) {
                console.error(e);
                statusEl.innerText = "Server Error (Run python!)";
                logChat("[Error] Запустите server.py чтобы работали моды!");
            }
        }

        // --- 4. МУЛЬТИПЛЕЕР (WebSockets) ---
        function initMultiplayer() {
            // Подключаемся к порту 8001 (как в server.py)
            const wsUrl = 'ws://' + window.location.hostname + ':8001';
            
            try {
                socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    logChat("Connected to Server!");
                    document.getElementById('my-id').style.color = 'green';
                };

                socket.onclose = () => {
                    document.getElementById('my-id').innerText = "Disconnected";
                    document.getElementById('my-id').style.color = 'red';
                };
                
                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'init') {
                        myId = data.id;
                        document.getElementById('my-id').innerText = myId;
                    }
                    else if (data.type === 'move') {
                        updateOtherPlayer(data);
                    }
                    else if (data.type === 'player_leave') {
                        removePlayer(data.id);
                    }
                };

                // Отправляем свои координаты 20 раз в секунду
                setInterval(() => {
                    if (socket.readyState === WebSocket.OPEN && myId) {
                        const pos = controls.getObject().position;
                        const rot = controls.getObject().rotation;
                        
                        socket.send(JSON.stringify({
                            type: 'move',
                            x: pos.x, y: pos.y, z: pos.z,
                            ry: rot.y
                        }));
                    }
                }, 50);

            } catch (e) {
                logChat("Multiplayer failed to connect.");
            }
        }

        function updateOtherPlayer(data) {
            // Если игрока еще нет, создаем его "куклу"
            if (!otherPlayers[data.id]) {
                const geo = new THREE.BoxGeometry(0.8, 1.8, 0.8);
                const mat = new THREE.MeshLambertMaterial({ color: 0xff4444 }); // Красный цвет
                const mesh = new THREE.Mesh(geo, mat);
                scene.add(mesh);
                otherPlayers[data.id] = mesh;
                
                // Создаем "голову" для красоты
                const headGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                const headMat = new THREE.MeshLambertMaterial({ color: 0xffcccc });
                const head = new THREE.Mesh(headGeo, headMat);
                head.position.y = 1.1;
                mesh.add(head);

                logChat(`Player ${data.id} joined.`);
            }

            // Обновляем позицию
            const mesh = otherPlayers[data.id];
            // Позиция приходит от камеры (глаз), поэтому опускаем модельку чуть ниже
            mesh.position.set(data.x, data.y - 1.5, data.z); 
            mesh.rotation.y = data.ry;
        }

        function removePlayer(id) {
            if (otherPlayers[id]) {
                scene.remove(otherPlayers[id]);
                delete otherPlayers[id];
                logChat(`Player ${id} disconnected.`);
            }
        }

        function logChat(text) {
            const el = document.getElementById('chat-log');
            const line = document.createElement('div');
            line.innerText = text;
            el.appendChild(line);
            el.scrollTop = el.scrollHeight; // Автоскролл
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- 5. ИГРОВОЙ ЦИКЛ ---
        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked) {
                // Замедление (инерция)
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 50.0 * delta; // Гравитация

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                controls.getObject().position.y += (velocity.y * delta);

                // Столкновение с полом (y = 0 плоскость)
                // Камера находится на высоте глаз, поэтому пол это не 0, а ~1.6
                if (controls.getObject().position.y < 2.0) { 
                    velocity.y = 0;
                    controls.getObject().position.y = 2.0;
                    canJump = true;
                }
            }
            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
